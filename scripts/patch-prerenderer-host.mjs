import fs from 'node:fs';
import path from 'node:path';

const PATCH_MARKER = '/* vibecoderai: support server.host */';

function patchFile(relPath, transform) {
  const absPath = path.join(process.cwd(), relPath);
  if (!fs.existsSync(absPath)) return { relPath, status: 'missing' };

  const original = fs.readFileSync(absPath, 'utf8');
  if (original.includes(PATCH_MARKER)) return { relPath, status: 'already_patched' };

  const updated = transform(original);
  if (updated === original) return { relPath, status: 'no_change' };

  fs.writeFileSync(absPath, updated, 'utf8');
  return { relPath, status: 'patched' };
}

const es6Result = patchFile(
  'node_modules/@prerenderer/prerenderer/es6/server.js',
  (src) =>
    src.replace(
      '      this._nativeServer = server.listen(this._options.server.port, () => {\n        resolve()\n      })\n',
      `      ${PATCH_MARKER}\n      const port = this._options.server.port;\n      const host = this._options.server.host;\n      this._nativeServer = host\n        ? server.listen(port, host, () => {\n            resolve();\n          })\n        : server.listen(port, () => {\n            resolve();\n          });\n`,
    ),
);

const es5Result = patchFile(
  'node_modules/@prerenderer/prerenderer/es5-autogenerated/server.js',
  (src) =>
    src.replace(
      "_this._nativeServer = server.listen(_this._options.server.port, function () {\n          resolve();\n        });",
      `${PATCH_MARKER}\n        var port = _this._options.server.port;\n        var host = _this._options.server.host;\n        _this._nativeServer = host ? server.listen(port, host, function () {\n          resolve();\n        }) : server.listen(port, function () {\n          resolve();\n        });`,
    ),
);

const results = [es6Result, es5Result];
const changed = results.some((r) => r.status === 'patched');
const failed = results.some((r) => r.status === 'no_change');

if (failed) {
  console.warn('[patch-prerenderer-host] Patch did not apply cleanly:', results);
} else if (changed) {
  console.log('[patch-prerenderer-host] Patched:', results);
}

